---
title: "Feux agricoles et pastoraux"
output: html_document
---

# Initialization

1.  Setup layout parameters

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

2.  Setup global options

```{r, include=FALSE}
#options(java.parameters = "- Xmx1024m") #Allow to increase memory limit
```

3.  Load required packages

```{r, message=FALSE}
library(tidyverse) # Easily Install and Load the 'Tidyverse'
library(readxl) # Read Excel Files, CRAN v1.3.1 
library(data.table) # Extension of `data.frame`
library(janitor) # Simple Tools for Examining and Cleaning Dirty Data
library(lubridate) # Make Dealing with Dates a Little Easier
library(annotater) # Annotate Package Load Calls, [github::luisDVA/annotater] v0.1.3
library(sf)
library(tmap)
library(leaflet)



```

4.  Get data

```{r}
feux_agri<-read_excel("data/Base-feux-agricoles-pastoraux2001-2021-10092021.xlsx",sheet = 1)
commune_gps<-read_csv2("data/commune_gps_tidied.csv")
```

# Data Cleaning and Tidying

1.  Data Cleaning

```{r}
feux_agri<-as_tibble(feux_agri)
feux_agri%>%
  filter(!mois=="")%>%
  select(!rmq&!`...10`)->feux_agri
```

2.  Data Tidying

```{r}
clean_names(feux_agri)->feux_agri
feux_agri%>%
  rename(code_commune=`x4`)->feux_agri
feux_agri%>%
  mutate(annee=as.integer(annee),
         mois=as.integer(mois),
         jour=as.integer(jour),
         code_commune=as.integer(code_commune),
         commune=as.character(commune),
         surface_ha=as.numeric(surface_ha),
         type_vegetation=as.factor(type_vegetation),
         source=as.factor(source))->feux_agri

# feux_agri%>%
#   filter(surface_ha=="na")%>%
#   count->na1
# test%>%
#   filter(is.na(surface_ha))%>%
#   count->na2
# na1==na2
# 
# seqna1<-which(feux_agri$surface_ha=="na")
# seqna2<-which(is.na(test$surface_ha))
# tabcomp<-cbind(seqna1,seqna2)
# tabcomp<-as_tibble(tabcomp)
# tabcomp%>%
#   mutate(diff=(seqna1-seqna2))->tabcomp
# tabcomp%>%
#   filter(diff!=0)

#370,1397,3225
feux_agri%>%
  slice(c(1:369,371:1396,1398:3224,3226:nrow(feux_agri)))%>%
  na.omit(code_commune)-> feux_agri

feux_agri%>% 
  mutate(date = make_datetime(annee, mois, jour))->feux_agri



commune_gps%>%
  mutate(code_insee=as.integer(code_insee),
         longitude=as.numeric(longitude))%>%
  na.omit(longitude)->commune_gps
```

3.  Data merging

```{r}
feux_main<-left_join(feux_agri,commune_gps,by=c("code_commune"="code_insee"))
feux_main%>%
  na.omit(latitude)->feux_main

```

4.  Creating other format files

```{r}
feux_sf<-st_as_sf(feux_main,
               coords = c("longitude","latitude"),
               crs="+proj=longlat +datum=WGS84 +nodefs")
```

# Data exploration

```{r}
feux_agri%>%
  group_by(mois,jour)%>%
  count%>%
  mutate(mois=as.factor(mois))%>%
  ggplot()+
  aes(x = jour,y=n,color=mois)+
  geom_line()
feux_agri%>%
  group_by(date)%>%
  count%>%
  ggplot()+
  aes(x=date,y=n)+
  geom_line()
feux_agri%>%
  group_by(code_commune)%>%
  count%>%
  arrange(desc(n))%>%
  ggplot()+
  aes(x = code_commune,y=n)+
  geom_line()
```

2.  Spatial exploration

```{r}
tmap_mode("view")
tm_shape(feux_sf)+
  tm_dots(size="surface_ha",col="surface_ha",palette=c('#ffffcc','#ffeda0','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#b10026'),
          title="Burned area (ha)",alpha=0.8,n=8,scale=2)

tm_shape(feux_sf)+
  tm_bubbles(size = "surface_ha",col = "red",scale = 1)
```
